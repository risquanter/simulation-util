# .github/workflows/release.yml
name: Release (YubiKey-signed)

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Build run ID to release'
        required: true

permissions:
  contents: write
  id-token: write

jobs:
  sign-and-publish:
    runs-on: [self-hosted, yubikey-signing]
    environment: release

    # Add environment variables at job level
    env:
      ARTIFACT_RUN_ID: ${{ inputs.run_id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq tar gpg2 scdaemon pcscd pinentry-curses

      - name: Download unsigned artifacts
        uses: actions/download-artifact@v4
        with:
          name: unsigned-artifacts-${{ inputs.run_id }}
          path: /tmp/release-artifacts

      - name: Download provenance
        uses: actions/download-artifact@v4
        with:
          name: provenance-${{ inputs.run_id }}
          path: /tmp/release-provenance

      - name: Extract and verify
        run: |
          mkdir -p /tmp/artifacts
          tar xzf /tmp/release-artifacts/artifacts.tgz -C /tmp/artifacts
          tar xzf /tmp/release-provenance/provenance.tgz -C /tmp/artifacts || true
          cd /tmp/artifacts
          sha256sum -c checksums.sha256

      - name: (Optional) Verify Sigstore provenance
        run: |
          for s in /tmp/artifacts/*.sigstore.json; do
            [ -f "$s" ] && sigstore verify --bundle "$s" || true
          done

      - name: Verify YubiKey and get signing key
        env:
          GPG_TTY: /dev/tty1
        run: |
          echo "Checking for YubiKey..."
          if ! gpg --card-status | grep -q "Signature key"; then
            echo "Error: No YubiKey with signing capability detected"
            exit 1
          fi

          # Get the signing key ID from the YubiKey
          SIGNING_KEY=$(gpg --card-status | grep "Signature key" | awk '{print $NF}')
          if [ -z "$SIGNING_KEY" ]; then
            echo "Error: Could not determine signing key from YubiKey"
            exit 1
          fi

          echo "YubiKey signing key: $SIGNING_KEY"
          echo "YUBIKEY_SIGNING_KEY=$SIGNING_KEY" >> $GITHUB_ENV

      - name: Sign artifacts with YubiKey (interactive)
        env:
          GPG_TTY: /dev/tty1
        run: |
          cd /tmp/artifacts
          for a in *.jar; do
            echo "Signing $a with YubiKey..."
            # Use specific YubiKey key, remove --batch to allow PIN entry
            gpg --local-user "$YUBIKEY_SIGNING_KEY" --detach-sign --armor --output "${a}.asc" "$a"

            # Create signature verification file with key fingerprint
            echo "Signature created by YubiKey: $YUBIKEY_SIGNING_KEY" > "${a}.keyinfo"
            echo "Timestamp: $(date -u)" >> "${a}.keyinfo"
            echo "Workflow: $GITHUB_WORKFLOW" >> "${a}.keyinfo"
            echo "Run ID: $GITHUB_RUN_ID" >> "${a}.keyinfo"
          done

      - name: Create signed git tag
        env:
          GPG_TTY: /dev/tty1
        run: |
          # Using shell parameter expansion for SHA substring
          RELEASE_TAG="v${GITHUB_SHA:0:8}"
          git config user.email "ci@risquanter.example"
          git config user.name "Release Bot"
          git tag -s "$RELEASE_TAG" -m "Release $RELEASE_TAG"
          git push origin "$RELEASE_TAG"

      - name: Write settings.xml for Sonatype
        env:
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        run: |
          mkdir -p "$HOME/.m2"
          cat > "$HOME/.m2/settings.xml" << 'EOF'
          <settings>
            <servers>
              <server>
                <id>ossrh</id>
                <username>${env.SONATYPE_USERNAME}</username>
                <password>${env.SONATYPE_PASSWORD}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Deploy to Maven Central
        env:
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        run: |
          cd /tmp/artifacts

          # Find the main JAR file (not sources or javadoc)
          MAIN_JAR=$(ls *.jar | grep -v -- "-sources.jar\|-javadoc.jar" | head -1)
          SOURCES_JAR=$(ls *-sources.jar | head -1)
          JAVADOC_JAR=$(ls *-javadoc.jar | head -1)

          if [ -z "$MAIN_JAR" ] || [ -z "$SOURCES_JAR" ] || [ -z "$JAVADOC_JAR" ]; then
            echo "Error: Missing required JAR files"
            echo "Main: $MAIN_JAR"
            echo "Sources: $SOURCES_JAR"
            echo "Javadoc: $JAVADOC_JAR"
            exit 1
          fi

          echo "Deploying artifacts with all required files and signatures..."

          # Deploy main JAR with all required files
          mvn -B deploy:deploy-file \
            -Durl=https://s01.oss.sonatype.org/service/local/staging/deploy/maven2/ \
            -DrepositoryId=ossrh \
            -Dfile="$MAIN_JAR" \
            -DpomFile="/workspace/pom.xml" \
            -DgroupId=com.risquanter \
            -DartifactId=simulation.util \
            -Dversion=0.6.0 \
            -Dpackaging=jar \
            -DgeneratePom=false \
            -Dfiles="$SOURCES_JAR,$JAVADOC_JAR,${MAIN_JAR}.asc,${SOURCES_JAR}.asc,${JAVADOC_JAR}.asc,${MAIN_JAR}.sig,${MAIN_JAR}.cert" \
            -Dclassifiers="sources,javadoc,signature,sources-signature,javadoc-signature,sigstore-sig,sigstore-cert" \
            -Dtypes="jar,jar,asc,asc,asc,sig,cert"

          echo "Deployment completed with YubiKey signatures and Sigstore attestations."
