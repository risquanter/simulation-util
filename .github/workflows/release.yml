###############################################################
# This workflow is adapted for Maven Central Publisher Portal
# Migration from OSSRH: all endpoints, authentication, and deployment
# now use the Central Publisher Portal API and token-based auth.
#
# Required repository secrets:
#   - GPG_PRIVATE_KEY: ASCII-armored GPG private key for signing
#   - GPG_PASSPHRASE: Passphrase for the GPG key
#   - TOTP_SECRET: Base32 secret for TOTP verification
#   - CENTRAL_PORTAL_USERNAME: Username (special purpose) for Maven Central Publisher Portal
#   - CENTRAL_PORTAL_TOKEN: Token generated from Maven Central Publisher Portal
#
# For details, see:
#   https://central.sonatype.org/publish/publish-portal-maven/
#   https://central.sonatype.org/publish/generate-portal-token/
###############################################################

name: Release (Maven Central Publisher Portal, GPG-signed)

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Build run ID to release'
        required: true
      totp_code:
        description: 'TOTP code from your authenticator app'
        required: true

permissions:
  contents: write
  id-token: write

jobs:
  verify-authorization:
    runs-on: ubuntu-latest
    steps:
      - name: Install oathtool
        run: sudo apt-get update && sudo apt-get install --no-install-recommends -y oathtool

      - name: Verify TOTP
        env:
          TOTP_SECRET: ${{ secrets.TOTP_SECRET }}
          INPUT_TOTP: ${{ inputs.totp_code }}
        run: |
          set -euo pipefail
          date --utc
          EXPECTED=$(oathtool --totp --base32 --time-step-size 60 "$TOTP_SECRET")
          if [ "${INPUT_TOTP}" != "$EXPECTED" ]; then
            echo "❌ Invalid TOTP code"
            echo "Expected: $EXPECTED"
            exit 1
          fi
          echo "✅ TOTP verified successfully"


  sign-and-publish:
    needs: verify-authorization
    runs-on: ubuntu-latest
    environment: release
    permissions:
      contents: write
      id-token: write
      actions: read

    env:
      ARTIFACT_RUN_ID: ${{ inputs.run_id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq tar gpg xmlstarlet

      - name: Download Maven deployment bundle
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run download ${{ inputs.run_id }} \
            --name deployment-${{ inputs.run_id }} \
            --dir /tmp/maven-release \
            --repo ${{ github.repository }}

      - name: Extract and verify artifacts
        run: |
          set -euo pipefail

          # Extract version from POM
          VERSION=$(xmlstarlet sel -t -v "/_:project/_:version" pom.xml)
          echo "Detected version: $VERSION"

          # Extract the Maven bundle
          cd /tmp/maven-release
          unzip -q maven-central-artifacts.zip -d /tmp/maven-deployment-contents

          # The JARs are located at: com/risquanter/simulation.util/$VERSION/
          JAR_PATH="/tmp/maven-deployment-contents/com/risquanter/simulation.util/$VERSION"
          echo "Looking for JARs in: $JAR_PATH"
          ls -la "$JAR_PATH"

      - name: Install cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Verify Sigstore signatures
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          set -euo pipefail

          VERSION=$(xmlstarlet sel -t -v "/_:project/_:version" pom.xml)
          JAR_PATH="/tmp/maven-deployment-contents/com/risquanter/simulation.util/$VERSION"

          echo "Verifying Sigstore signatures..."

          # Verify each JAR file against its Sigstore signature
          cd "$JAR_PATH"
          for jar in simulation.util-*.jar; do
            if [[ -f "${jar}.sigstore.json" ]]; then
              echo "Verifying $jar..."
              cosign verify-blob --bundle "${jar}.sigstore.json" \
                --certificate-identity-regexp="https://github.com/risquanter/simulation-util/.github/workflows/ci-build.yml@refs/heads/main" \
                --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
                "$jar"
              echo "✅ $jar signature verified"
            else
              echo "❌ Missing sigstore.json for $jar"
              exit 1
            fi
          done

          # Verify POM file signature
          POM_FILE="simulation.util-$VERSION.pom"
          if [[ -f "${POM_FILE}.sigstore.json" ]]; then
            echo "Verifying $POM_FILE..."
            cosign verify-blob --bundle "${POM_FILE}.sigstore.json" \
              --certificate-identity-regexp="https://github.com/risquanter/simulation-util/.github/workflows/ci-build.yml@refs/heads/main" \
              --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
              "$POM_FILE"
            echo "✅ $POM_FILE signature verified"
          else
            echo "❌ Missing sigstore.json for $POM_FILE"
            exit 1
          fi

          echo "✅ All JAR and POM signatures verified successfully"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Write settings.xml for Central Publisher Portal
        env:
          CENTRAL_PORTAL_USERNAME: ${{ secrets.CENTRAL_PORTAL_USERNAME }}
          CENTRAL_PORTAL_TOKEN: ${{ secrets.CENTRAL_PORTAL_TOKEN }}
        run: |
          mkdir -p "$HOME/.m2"
          cat > "$HOME/.m2/settings.xml" << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0">
            <servers>
              <server>
                <id>central</id>
                <username>USERNAME_PLACEHOLDER</username>
                <password>PASSWORD_PLACEHOLDER</password>
              </server>
            </servers>
          </settings>
          EOF

          sed -i "s/USERNAME_PLACEHOLDER/${CENTRAL_PORTAL_USERNAME}/g" "$HOME/.m2/settings.xml"
          sed -i "s/PASSWORD_PLACEHOLDER/${CENTRAL_PORTAL_TOKEN}/g" "$HOME/.m2/settings.xml"
          chmod 600 "$HOME/.m2/settings.xml"

      - name: Deploy to Maven Central Publisher Portal
        env:
          CENTRAL_PORTAL_USERNAME: ${{ secrets.CENTRAL_PORTAL_USERNAME }}
          CENTRAL_PORTAL_TOKEN: ${{ secrets.CENTRAL_PORTAL_TOKEN }}
        run: |
          set -euo pipefail

          VERSION=$(xmlstarlet sel -t -v "/_:project/_:version" pom.xml)
          echo "Deploying version: $VERSION"

          # Use the pre-built Maven bundle
          mkdir -p target
          cp /tmp/maven-release/maven-central-artifacts.zip target/

          echo "Bundle structure:"
          unzip -l target/maven-central-artifacts.zip

          # Upload to Central Portal using REST API
          echo "Uploading to Central Portal..."
          BEARER_TOKEN=$(printf "%s:%s" "${CENTRAL_PORTAL_USERNAME}" "${CENTRAL_PORTAL_TOKEN}" | base64 -w 0)

          UPLOAD_RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer ${BEARER_TOKEN}" \
            -F "bundle=@target/maven-central-artifacts.zip" \
            "https://central.sonatype.com/api/v1/publisher/upload?name=simulation.util-${VERSION}&publishingType=USER_MANAGED")

          echo "Upload response: $UPLOAD_RESPONSE"

          # The response is the deployment ID directly (not JSON)
          DEPLOYMENT_ID=$(echo "$UPLOAD_RESPONSE" | tr -d '[:space:]')
          echo "Deployment ID: $DEPLOYMENT_ID"

          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "❌ Failed to get deployment ID"
            echo "Full response: $UPLOAD_RESPONSE"
            exit 1
          fi

          # Check deployment status
          echo "Checking deployment status..."
          STATUS_RESPONSE=$(curl -X POST "https://central.sonatype.com/api/v1/publisher/status?id=$DEPLOYMENT_ID" \
            -H "Authorization: Bearer ${BEARER_TOKEN}" -H "Content-Type: application/json")

          echo "Deployment status: $STATUS_RESPONSE"
          echo "✅ Deployment completed (staged). Visit https://central.sonatype.com/ to publish."

      - name: Clean up
        if: always()
        run: |
          rm -f "$HOME/.m2/settings.xml" 2>/dev/null || true
